import * as React from 'react';

const { useState, createElement: e } = React;


interface BookingModalProps {
  hotel: any;
  isOpen: boolean;
  onClose: () => void;
}

const BookingModal = ({ hotel, isOpen, onClose }: BookingModalProps) => {
  const [copiedSite, setCopiedSite] = useState<string | null>(null);
  const [copiedInfo, setCopiedInfo] = useState<string | null>(null);
  const [prices, setPrices] = useState<any>(null);
  const [loadingPrices, setLoadingPrices] = useState(false);
  
  // ‰æ°Ê†º„ÇíÂèñÂæó
  React.useEffect(() => {
    if (isOpen && hotel) {
      setLoadingPrices(true);
      fetch(`/api/hotel-prices?hotelName=${encodeURIComponent(hotel.name)}`)
        .then(res => res.json())
        .then(data => {
          setPrices(data);
          setLoadingPrices(false);
        })
        .catch(err => {
          console.error('Failed to fetch prices:', err);
          setLoadingPrices(false);
        });
    }
  }, [isOpen, hotel]);
  
  if (!isOpen) return null;

  const handleCopyInfo = async (info: string, type: string) => {
    try {
      await navigator.clipboard.writeText(info);
      setCopiedInfo(type);
      setTimeout(() => setCopiedInfo(null), 3000);
    } catch (err) {
      console.error('Copy failed:', err);
    }
  };

  const handleSiteClick = async (site: any, event: React.MouseEvent<HTMLAnchorElement>) => {
    // Ê•ΩÂ§©„Éà„É©„Éô„É´„Å®„Åò„ÇÉ„Çâ„Çì„ÅÆÂ†¥Âêà„ÅØ„Éõ„ÉÜ„É´Âêç„Çí„Ç≥„Éî„Éº
    if (site.name === 'Ê•ΩÂ§©„Éà„É©„Éô„É´' || site.name === '„Åò„ÇÉ„Çâ„Çì') {
      event.preventDefault();
      
      try {
        await navigator.clipboard.writeText(hotel.name);
        setCopiedSite(site.name);
        
        // 3ÁßíÂæå„Å´„Ç≥„Éî„ÉºÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
        setTimeout(() => setCopiedSite(null), 3000);
        
        // Â∞ë„ÅóÈÅÖ„Çå„Å¶„Éö„Éº„Ç∏„ÇíÈñã„ÅèÔºà„Ç≥„Éî„ÉºÂÆå‰∫Ü„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åã„ÇâÔºâ
        setTimeout(() => {
          window.open(site.url, '_blank');
        }, 300);
      } catch (err) {
        // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„ÉâAPI„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥Âêà„ÅØÁõ¥Êé•Èñã„Åè
        window.open(site.url, '_blank');
      }
    }
  };

  const bookingSites = [
    {
      name: 'Google Hotels',
      description: 'Ë§áÊï∞„Çµ„Ç§„Éà„ÅÆ‰æ°Ê†º„ÇíÊØîËºÉ',
      color: '#4285f4',
      icon: 'üîç',
      url: `https://www.google.com/travel/hotels/search?q=${encodeURIComponent(hotel.name)}+${encodeURIComponent(hotel.city || '')}`,
      price: prices?.google ? `¬•${prices.google.minPrice.toLocaleString()}„Äú` : null
    },
    {
      name: 'Booking.com',
      description: '‰∏ñÁïåÊúÄÂ§ßÁ¥ö„ÅÆ‰∫àÁ¥Ñ„Çµ„Ç§„Éà',
      color: '#003580',
      icon: 'üè®',
      url: `https://www.booking.com/search.html?ss=${encodeURIComponent(hotel.name)}+${encodeURIComponent(hotel.city || '')}`,
      price: prices?.booking ? `¬•${prices.booking.price.toLocaleString()}„Äú` : null
    },
    {
      name: 'Ê•ΩÂ§©„Éà„É©„Éô„É´',
      description: copiedSite === 'Ê•ΩÂ§©„Éà„É©„Éô„É´' ? '‚úÖ „Ç≥„Éî„ÉºÂÆå‰∫ÜÔºÅÊ§úÁ¥¢Á™ì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ' : 'üìã „ÇØ„É™„ÉÉ„ÇØ„Åß„Éõ„ÉÜ„É´Âêç„Çí„Ç≥„Éî„Éº‚ÜíÊ§úÁ¥¢',
      color: '#bf0000',
      icon: 'üáØüáµ',
      url: 'https://travel.rakuten.co.jp/',
      needsCopy: true,
      price: prices?.rakuten ? `¬•${prices.rakuten.price.toLocaleString()}„Äú` : null
    },
    {
      name: '„Åò„ÇÉ„Çâ„Çì',
      description: copiedSite === '„Åò„ÇÉ„Çâ„Çì' ? '‚úÖ „Ç≥„Éî„ÉºÂÆå‰∫ÜÔºÅÊ§úÁ¥¢Á™ì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ' : 'üìã „ÇØ„É™„ÉÉ„ÇØ„Åß„Éõ„ÉÜ„É´Âêç„Çí„Ç≥„Éî„Éº‚ÜíÊ§úÁ¥¢',
      color: '#f50057',
      icon: '‚ú®',
      url: 'https://www.jalan.net/',
      needsCopy: true,
      price: prices?.jalan ? `¬•${prices.jalan.price.toLocaleString()}„Äú` : null
    }
  ];

  return e('div', {
    style: {
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: 'rgba(0, 0, 0, 0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000
    },
    onClick: onClose
  }, e('div', {
    style: {
      backgroundColor: 'white',
      borderRadius: '12px',
      padding: '24px',
      maxWidth: '500px',
      width: '90%',
      maxHeight: '80vh',
      overflow: 'auto',
      boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)'
    },
    onClick: (e: any) => e.stopPropagation()
  }, [
    // „Éò„ÉÉ„ÉÄ„Éº
    e('div', {
      key: 'header',
      style: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: '24px'
      }
    }, [
      e('div', { key: 'title-section' }, [
        e('h2', {
          key: 'title',
          style: {
            fontSize: '24px',
            fontWeight: 'bold',
            margin: 0
          }
        }, '‰∫àÁ¥Ñ„Çµ„Ç§„Éà„ÇíÈÅ∏Êäû'),
        e('p', {
          key: 'hotel-name',
          style: {
            fontSize: '16px',
            color: '#666',
            marginTop: '4px'
          }
        }, hotel.name)
      ]),
      e('button', {
        key: 'close',
        onClick: onClose,
        style: {
          background: 'none',
          border: 'none',
          fontSize: '24px',
          cursor: 'pointer',
          padding: '4px',
          color: '#666'
        }
      }, '√ó')
    ]),

    // ‰∫àÁ¥Ñ„Çµ„Ç§„Éà„É™„Çπ„Éà
    e('div', {
      key: 'sites',
      style: {
        display: 'flex',
        flexDirection: 'column',
        gap: '12px'
      }
    }, bookingSites.map(site => 
      e('a', {
        key: site.name,
        href: site.url,
        target: '_blank',
        rel: 'noopener noreferrer',
        onClick: (e: any) => handleSiteClick(site, e),
        style: {
          display: 'flex',
          alignItems: 'center',
          padding: '16px',
          borderRadius: '8px',
          border: '1px solid #e0e0e0',
          textDecoration: 'none',
          color: 'inherit',
          transition: 'all 0.2s',
          backgroundColor: 'white'
        },
        onMouseEnter: (e: any) => {
          e.currentTarget.style.backgroundColor = '#f5f5f5';
          e.currentTarget.style.borderColor = site.color;
          e.currentTarget.style.transform = 'translateY(-2px)';
          e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        },
        onMouseLeave: (e: any) => {
          e.currentTarget.style.backgroundColor = 'white';
          e.currentTarget.style.borderColor = '#e0e0e0';
          e.currentTarget.style.transform = 'translateY(0)';
          e.currentTarget.style.boxShadow = 'none';
        }
      }, [
        e('span', {
          key: 'icon',
          style: {
            fontSize: '32px',
            marginRight: '16px'
          }
        }, site.icon),
        e('div', {
          key: 'info',
          style: { flex: 1 }
        }, [
          e('div', {
            key: 'name',
            style: {
              fontSize: '18px',
              fontWeight: '600',
              color: site.color,
              marginBottom: '4px'
            }
          }, site.name),
          e('div', {
            key: 'desc',
            style: {
              fontSize: '14px',
              color: '#666'
            }
          }, site.description),
          // ‰æ°Ê†ºË°®Á§∫
          site.price && e('div', {
            key: 'price',
            style: {
              fontSize: '16px',
              fontWeight: 'bold',
              color: site.color,
              marginTop: '4px'
            }
          }, loadingPrices ? '‰æ°Ê†º„ÇíÂèñÂæó‰∏≠...' : site.price)
        ]),
        // ‰æ°Ê†ºË°®Á§∫ÔºàÁ∏¶„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ
        !site.price && loadingPrices && e('div', {
          key: 'loading-price',
          style: {
            fontSize: '12px',
            color: '#9ca3af',
            marginRight: '12px'
          }
        }, '...'),
        e('svg', {
          key: 'arrow',
          width: '20',
          height: '20',
          viewBox: '0 0 20 20',
          fill: site.color,
          style: { opacity: 0.5 }
        }, e('path', {
          d: 'M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z'
        }))
      ])
    )),

    // „Éõ„ÉÜ„É´ÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥
    e('div', {
      key: 'hotel-info',
      style: {
        background: '#f8f9fa',
        borderRadius: '8px',
        padding: '16px',
        marginBottom: '20px'
      }
    }, [
      e('h3', {
        key: 'info-title',
        style: {
          fontSize: '14px',
          fontWeight: 'bold',
          marginBottom: '12px',
          color: '#374151'
        }
      }, 'üè® „Éõ„ÉÜ„É´ÊÉÖÂ†±Ôºà„ÇØ„É™„ÉÉ„ÇØ„Åß„Ç≥„Éî„ÉºÔºâ'),
      
      // „Éõ„ÉÜ„É´Âêç
      e('div', {
        key: 'hotel-name-info',
        style: {
          marginBottom: '8px',
          cursor: 'pointer',
          padding: '8px',
          borderRadius: '4px',
          background: copiedInfo === 'name' ? '#d1fae5' : 'transparent',
          transition: 'background 0.2s'
        },
        onClick: () => handleCopyInfo(hotel.name, 'name')
      }, [
        e('span', { key: 'label', style: { fontSize: '12px', color: '#6b7280' } }, '„Éõ„ÉÜ„É´Âêç: '),
        e('span', { key: 'value', style: { fontSize: '14px', fontWeight: '500' } }, hotel.name)
      ]),
      
      // ‰ΩèÊâÄ
      hotel.location && e('div', {
        key: 'location-info',
        style: {
          marginBottom: '8px',
          cursor: 'pointer',
          padding: '8px',
          borderRadius: '4px',
          background: copiedInfo === 'location' ? '#d1fae5' : 'transparent',
          transition: 'background 0.2s'
        },
        onClick: () => handleCopyInfo(hotel.location, 'location')
      }, [
        e('span', { key: 'label', style: { fontSize: '12px', color: '#6b7280' } }, '‰ΩèÊâÄ: '),
        e('span', { key: 'value', style: { fontSize: '14px' } }, hotel.location)
      ]),
      
      // ÊúÄÂØÑ„ÇäÈßÖ
      hotel.nearestStation && e('div', {
        key: 'station-info',
        style: {
          cursor: 'pointer',
          padding: '8px',
          borderRadius: '4px',
          background: copiedInfo === 'station' ? '#d1fae5' : 'transparent',
          transition: 'background 0.2s'
        },
        onClick: () => handleCopyInfo(hotel.nearestStation, 'station')
      }, [
        e('span', { key: 'label', style: { fontSize: '12px', color: '#6b7280' } }, 'ÊúÄÂØÑ„ÇäÈßÖ: '),
        e('span', { key: 'value', style: { fontSize: '14px' } }, hotel.nearestStation)
      ])
    ]),

    // Ê§úÁ¥¢„ÅÆ„Ç≥„ÉÑ
    e('div', {
      key: 'search-tips',
      style: {
        background: '#fef3c7',
        borderRadius: '8px',
        padding: '16px',
        marginBottom: '20px'
      }
    }, [
      e('h3', {
        key: 'tips-title',
        style: {
          fontSize: '14px',
          fontWeight: 'bold',
          marginBottom: '8px',
          color: '#92400e'
        }
      }, 'üîç Ê•ΩÂ§©„Éª„Åò„ÇÉ„Çâ„Çì„Åß„ÅÆÊ§úÁ¥¢ÊñπÊ≥ï'),
      e('ol', {
        key: 'tips-list',
        style: {
          margin: 0,
          paddingLeft: '20px',
          fontSize: '12px',
          color: '#78350f'
        }
      }, [
        e('li', { key: '1', style: { marginBottom: '4px' } }, '„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„ÅåÈñã„Åç„Åæ„Åô'),
        e('li', { key: '2', style: { marginBottom: '4px' } }, 'Ê§úÁ¥¢Á™ì„Å´„Éõ„ÉÜ„É´Âêç„ÇíË≤º„Çä‰ªò„ÅëÔºàCtrl+V/Cmd+VÔºâ'),
        e('li', { key: '3', style: { marginBottom: '4px' } }, 'Ê§úÁ¥¢„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ')
      ])
    ]),

    // Ê≥®ÊÑè‰∫ãÈ†Ö
    e('p', {
      key: 'note',
      style: {
        marginTop: '20px',
        fontSize: '11px',
        color: '#9ca3af',
        textAlign: 'center'
      }
    }, '‚Äª Google Hotels„ÉªBooking.com„ÅØÁõ¥Êé•Ê§úÁ¥¢ÁµêÊûú„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô')
  ]));
};

export default BookingModal;