/**
 * LINE Messaging API Integration Service
 * Premium LINE notifications for luxury hotel availability alerts
 */

const axios = require('axios');
const crypto = require('crypto');
const envManager = require('../../production-config/env-manager');

class LineNotificationService {
  constructor() {
    this.channelAccessToken = null;
    this.channelSecret = null;
    this.lineApiUrl = 'https://api.line.me/v2/bot';
    this.lineNotifyUrl = 'https://notify-api.line.me/api/notify';
    this.isInitialized = false;
    this.webhookUrl = null;
  }

  async initialize() {
    try {
      this.channelAccessToken = envManager.get('LINE_CHANNEL_ACCESS_TOKEN');
      this.channelSecret = envManager.get('LINE_CHANNEL_SECRET');
      this.webhookUrl = envManager.get('LINE_WEBHOOK_URL') || 'https://api.hotelbooking.com/webhook/line';

      if (!this.channelAccessToken || !this.channelSecret) {
        throw new Error('LINE API credentials not configured');
      }

      this.isInitialized = true;
      console.log('‚úÖ LINE notification service initialized');
      
    } catch (error) {
      console.error('‚ùå Failed to initialize LINE service:', error);
      throw error;
    }
  }

  async sendLuxuryAvailabilityAlert(data) {
    const {
      lineUserId,
      userName,
      hotelName,
      roomType,
      checkInDate,
      checkOutDate,
      currentPrice,
      discountPercentage,
      urgencyLevel,
      isLuxurySuite,
      bookingUrl
    } = data;

    // Create rich message with Flex Message
    const flexMessage = this.createLuxuryAvailabilityFlexMessage({
      hotelName,
      roomType,
      checkInDate,
      checkOutDate,
      currentPrice,
      discountPercentage,
      urgencyLevel,
      isLuxurySuite,
      bookingUrl
    });

    const message = {
      to: lineUserId,
      messages: [
        {
          type: 'text',
          text: this.generateUrgencyMessage(urgencyLevel, hotelName, discountPercentage)
        },
        flexMessage
      ]
    };

    return await this.sendMessage(message);
  }

  createLuxuryAvailabilityFlexMessage(data) {
    const {
      hotelName,
      roomType,
      checkInDate,
      checkOutDate,
      currentPrice,
      discountPercentage,
      urgencyLevel,
      isLuxurySuite,
      bookingUrl
    } = data;

    const urgencyColor = this.getUrgencyColor(urgencyLevel);
    const urgencyEmoji = this.getUrgencyEmoji(urgencyLevel);
    const luxuryIcon = isLuxurySuite ? 'üëë' : 'üè®';

    return {
      type: 'flex',
      altText: `${urgencyEmoji} ${hotelName} ${roomType} Á©∫ÂÆ§„Ç¢„É©„Éº„Éà`,
      contents: {
        type: 'bubble',
        size: 'kilo',
        header: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                {
                  type: 'text',
                  text: urgencyEmoji,
                  size: 'lg',
                  flex: 0
                },
                {
                  type: 'text',
                  text: 'È´òÁ¥öÂÆ¢ÂÆ§Á©∫ÂÆ§„Ç¢„É©„Éº„Éà',
                  weight: 'bold',
                  color: '#ffffff',
                  size: 'md',
                  flex: 1,
                  margin: 'md'
                }
              ]
            }
          ],
          backgroundColor: urgencyColor,
          paddingAll: 'lg'
        },
        hero: {
          type: 'image',
          url: `https://cdn.hotelbooking.com/hotels/${hotelName.replace(/\s+/g, '-').toLowerCase()}/hero.jpg`,
          size: 'full',
          aspectRatio: '20:13',
          aspectMode: 'cover',
          action: {
            type: 'uri',
            uri: bookingUrl
          }
        },
        body: {
          type: 'box',
          layout: 'vertical',
          spacing: 'md',
          contents: [
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                {
                  type: 'text',
                  text: luxuryIcon,
                  size: 'lg',
                  flex: 0
                },
                {
                  type: 'text',
                  text: hotelName,
                  weight: 'bold',
                  size: 'lg',
                  color: '#333333',
                  flex: 1,
                  margin: 'sm'
                }
              ]
            },
            {
              type: 'text',
              text: roomType,
              size: 'md',
              color: '#666666',
              margin: 'sm'
            },
            {
              type: 'separator',
              margin: 'lg'
            },
            {
              type: 'box',
              layout: 'vertical',
              spacing: 'sm',
              margin: 'lg',
              contents: [
                {
                  type: 'box',
                  layout: 'horizontal',
                  contents: [
                    {
                      type: 'text',
                      text: 'üìÖ „ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥',
                      size: 'sm',
                      color: '#666666',
                      flex: 2
                    },
                    {
                      type: 'text',
                      text: this.formatDate(checkInDate),
                      size: 'sm',
                      color: '#333333',
                      weight: 'bold',
                      flex: 3,
                      align: 'end'
                    }
                  ]
                },
                {
                  type: 'box',
                  layout: 'horizontal',
                  contents: [
                    {
                      type: 'text',
                      text: 'üìÖ „ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà',
                      size: 'sm',
                      color: '#666666',
                      flex: 2
                    },
                    {
                      type: 'text',
                      text: this.formatDate(checkOutDate),
                      size: 'sm',
                      color: '#333333',
                      weight: 'bold',
                      flex: 3,
                      align: 'end'
                    }
                  ]
                }
              ]
            },
            {
              type: 'separator',
              margin: 'lg'
            },
            {
              type: 'box',
              layout: 'horizontal',
              margin: 'lg',
              contents: [
                {
                  type: 'text',
                  text: 'üí∞',
                  size: 'lg',
                  flex: 0
                },
                {
                  type: 'box',
                  layout: 'vertical',
                  flex: 1,
                  margin: 'sm',
                  contents: [
                    {
                      type: 'text',
                      text: this.formatCurrency(currentPrice),
                      size: 'xl',
                      weight: 'bold',
                      color: '#333333'
                    },
                    {
                      type: 'text',
                      text: '1Ê≥ä„ÅÇ„Åü„ÇäÔºàÁ®éËæºÔºâ',
                      size: 'xs',
                      color: '#666666'
                    }
                  ]
                },
                ...(discountPercentage > 0 ? [{
                  type: 'box',
                  layout: 'vertical',
                  flex: 1,
                  contents: [
                    {
                      type: 'text',
                      text: `${Math.round(discountPercentage)}% OFF`,
                      size: 'sm',
                      weight: 'bold',
                      color: '#ffffff',
                      align: 'center',
                      backgroundColor: '#ff4444',
                      paddingAll: 'xs',
                      cornerRadius: 'md'
                    }
                  ]
                }] : [])
              ]
            }
          ]
        },
        footer: {
          type: 'box',
          layout: 'vertical',
          spacing: 'sm',
          contents: [
            {
              type: 'button',
              style: 'primary',
              height: 'sm',
              action: {
                type: 'uri',
                label: '‰ªä„Åô„Åê‰∫àÁ¥Ñ„Åô„Çã üöÄ',
                uri: bookingUrl
              },
              color: '#ff4444'
            },
            {
              type: 'button',
              style: 'secondary',
              height: 'sm',
              action: {
                type: 'uri',
                label: 'Ë©≥Á¥∞„ÇíË¶ã„Çã',
                uri: bookingUrl.replace('/book', '/details')
              }
            }
          ]
        }
      }
    };
  }

  async sendPriceDropAlert(data) {
    const {
      lineUserId,
      hotelName,
      roomType,
      originalPrice,
      newPrice,
      discountPercentage,
      validUntil,
      bookingUrl
    } = data;

    const savings = originalPrice - newPrice;
    const timeLeft = this.calculateTimeLeft(validUntil);

    const flexMessage = {
      type: 'flex',
      altText: `üí∞ ${hotelName} ${Math.round(discountPercentage)}%OFF ‰æ°Ê†º‰∏ãËêΩ„Ç¢„É©„Éº„Éà`,
      contents: {
        type: 'bubble',
        header: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'text',
              text: 'üí∞ ‰æ°Ê†º‰∏ãËêΩ„Ç¢„É©„Éº„Éà',
              weight: 'bold',
              color: '#ffffff',
              size: 'lg'
            }
          ],
          backgroundColor: '#ff6b35',
          paddingAll: 'lg'
        },
        body: {
          type: 'box',
          layout: 'vertical',
          spacing: 'md',
          contents: [
            {
              type: 'text',
              text: hotelName,
              weight: 'bold',
              size: 'lg',
              color: '#333333'
            },
            {
              type: 'text',
              text: roomType,
              size: 'md',
              color: '#666666'
            },
            {
              type: 'separator',
              margin: 'lg'
            },
            {
              type: 'box',
              layout: 'horizontal',
              margin: 'lg',
              contents: [
                {
                  type: 'box',
                  layout: 'vertical',
                  flex: 1,
                  contents: [
                    {
                      type: 'text',
                      text: 'ÈÄöÂ∏∏‰æ°Ê†º',
                      size: 'sm',
                      color: '#666666'
                    },
                    {
                      type: 'text',
                      text: this.formatCurrency(originalPrice),
                      size: 'md',
                      color: '#999999',
                      decoration: 'line-through'
                    }
                  ]
                },
                {
                  type: 'box',
                  layout: 'vertical',
                  flex: 1,
                  contents: [
                    {
                      type: 'text',
                      text: 'Áâπ‰æ°',
                      size: 'sm',
                      color: '#666666'
                    },
                    {
                      type: 'text',
                      text: this.formatCurrency(newPrice),
                      size: 'xl',
                      weight: 'bold',
                      color: '#ff4444'
                    }
                  ]
                }
              ]
            },
            {
              type: 'box',
              layout: 'horizontal',
              margin: 'lg',
              contents: [
                {
                  type: 'text',
                  text: `${this.formatCurrency(savings)} „ÅäÂæóÔºÅ`,
                  size: 'lg',
                  weight: 'bold',
                  color: '#00aa00',
                  flex: 1
                },
                {
                  type: 'text',
                  text: `${Math.round(discountPercentage)}% OFF`,
                  size: 'md',
                  weight: 'bold',
                  color: '#ffffff',
                  backgroundColor: '#ff4444',
                  paddingAll: 'xs',
                  cornerRadius: 'md',
                  align: 'center'
                }
              ]
            },
            {
              type: 'text',
              text: `‚è∞ ÊÆã„Çä${timeLeft}`,
              size: 'sm',
              color: '#ff4444',
              weight: 'bold',
              margin: 'lg'
            }
          ]
        },
        footer: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'button',
              style: 'primary',
              action: {
                type: 'uri',
                label: '‰ªä„Åô„Åê‰∫àÁ¥Ñ„Åô„Çã üî•',
                uri: bookingUrl
              },
              color: '#ff4444'
            }
          ]
        }
      }
    };

    const message = {
      to: lineUserId,
      messages: [
        {
          type: 'text',
          text: `üî• ${hotelName}„Åß${Math.round(discountPercentage)}%„ÅÆÂ§ßÂπÖÂÄ§‰∏ã„Åí„ÅåÁô∫Áîü„Åó„Åæ„Åó„ÅüÔºÅ\n\n${this.formatCurrency(savings)}„ÇÇ„ÅäÂæó„Å´ÂÆøÊ≥ä„Åß„Åç„Çã„ÉÅ„É£„É≥„Çπ„Åß„Åô„ÄÇ„Åì„ÅÆ‰æ°Ê†º„ÅØ${timeLeft}ÈôêÂÆö„Åß„ÅôÔºÅ`
        },
        flexMessage
      ]
    };

    return await this.sendMessage(message);
  }

  async sendLastMinuteDeal(data) {
    const {
      lineUserId,
      deals,
      expiresIn,
      totalSavings
    } = data;

    const carouselContents = deals.slice(0, 10).map(deal => ({
      type: 'bubble',
      size: 'micro',
      header: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'text',
            text: '‚ö° „É©„Çπ„Éà„Éü„Éã„ÉÉ„ÉÑ',
            size: 'sm',
            weight: 'bold',
            color: '#ffffff'
          }
        ],
        backgroundColor: '#ff8c00',
        paddingAll: 'sm'
      },
      body: {
        type: 'box',
        layout: 'vertical',
        spacing: 'sm',
        contents: [
          {
            type: 'text',
            text: deal.hotelName,
            weight: 'bold',
            size: 'sm',
            wrap: true
          },
          {
            type: 'text',
            text: deal.roomType,
            size: 'xs',
            color: '#666666',
            wrap: true
          },
          {
            type: 'text',
            text: this.formatCurrency(deal.price),
            size: 'lg',
            weight: 'bold',
            color: '#ff4444'
          },
          {
            type: 'text',
            text: `${deal.discount}% OFF`,
            size: 'xs',
            color: '#00aa00',
            weight: 'bold'
          }
        ]
      },
      footer: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'button',
            style: 'primary',
            height: 'sm',
            action: {
              type: 'uri',
              label: '‰∫àÁ¥Ñ',
              uri: deal.bookingUrl
            },
            color: '#ff4444'
          }
        ]
      }
    }));

    const message = {
      to: lineUserId,
      messages: [
        {
          type: 'text',
          text: `‚è∞ „É©„Çπ„Éà„Éü„Éã„ÉÉ„ÉÑÁâπ‰æ°ÊÉÖÂ†±ÔºÅ\n\n${deals.length}‰ª∂„ÅÆË∂Ö„ÅäÂæó„Å™„Éó„É©„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü„ÄÇ\nÂêàË®à${this.formatCurrency(totalSavings)}„ÅÆÁØÄÁ¥Ñ„ÉÅ„É£„É≥„ÇπÔºÅ\n\n‚ö†Ô∏è ÊÆã„Çä${expiresIn}ÂàÜ„ÅßÁµÇ‰∫Ü„Åó„Åæ„Åô`
        },
        {
          type: 'flex',
          altText: `‚ö° „É©„Çπ„Éà„Éü„Éã„ÉÉ„ÉÑÁâπ‰æ° ${deals.length}‰ª∂`,
          contents: {
            type: 'carousel',
            contents: carouselContents
          }
        }
      ]
    };

    return await this.sendMessage(message);
  }

  async sendMessage(messageData) {
    if (!this.isInitialized) {
      await this.initialize();
    }

    try {
      const response = await axios.post(
        `${this.lineApiUrl}/message/push`,
        messageData,
        {
          headers: {
            'Authorization': `Bearer ${this.channelAccessToken}`,
            'Content-Type': 'application/json'
          }
        }
      );

      console.log(`üì± LINE message sent successfully to ${messageData.to}`);
      
      return {
        success: true,
        messageId: response.headers['x-line-request-id'],
        timestamp: new Date().toISOString(),
        recipient: messageData.to
      };

    } catch (error) {
      console.error(`‚ùå Failed to send LINE message:`, error.response?.data || error.message);
      
      return {
        success: false,
        error: error.response?.data?.message || error.message,
        code: error.response?.status || 'UNKNOWN',
        timestamp: new Date().toISOString(),
        recipient: messageData.to
      };
    }
  }

  async sendBulkMessages(messages) {
    const results = [];
    
    // LINE API rate limit: 1000 messages per second
    const batchSize = 100;
    const delayMs = 100;
    
    for (let i = 0; i < messages.length; i += batchSize) {
      const batch = messages.slice(i, i + batchSize);
      
      const batchPromises = batch.map(async (message) => {
        try {
          return await this.sendMessage(message);
        } catch (error) {
          return {
            success: false,
            error: error.message,
            message: message
          };
        }
      });
      
      const batchResults = await Promise.allSettled(batchPromises);
      results.push(...batchResults.map(r => r.value || r.reason));
      
      // Rate limiting delay
      if (i + batchSize < messages.length) {
        await new Promise(resolve => setTimeout(resolve, delayMs));
      }
    }
    
    return results;
  }

  async handleWebhook(signature, body) {
    // Verify webhook signature
    const hash = crypto
      .createHmac('SHA256', this.channelSecret)
      .update(body, 'utf8')
      .digest('base64');

    if (signature !== hash) {
      throw new Error('Invalid signature');
    }

    const data = JSON.parse(body);
    const results = [];

    for (const event of data.events) {
      try {
        const result = await this.handleEvent(event);
        results.push(result);
      } catch (error) {
        console.error('Error handling LINE event:', error);
        results.push({ error: error.message, event });
      }
    }

    return results;
  }

  async handleEvent(event) {
    switch (event.type) {
      case 'message':
        return await this.handleMessageEvent(event);
      case 'follow':
        return await this.handleFollowEvent(event);
      case 'unfollow':
        return await this.handleUnfollowEvent(event);
      case 'postback':
        return await this.handlePostbackEvent(event);
      default:
        return { type: 'ignored', eventType: event.type };
    }
  }

  async handleMessageEvent(event) {
    const userId = event.source.userId;
    const messageText = event.message.text;

    // Simple command handling
    if (messageText === 'Ë®≠ÂÆö' || messageText === 'setting') {
      const settingsUrl = `https://hotelbooking.com/settings?line_user_id=${userId}`;
      
      const replyMessage = {
        type: 'flex',
        altText: 'ÈÄöÁü•Ë®≠ÂÆö',
        contents: {
          type: 'bubble',
          body: {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: '‚öôÔ∏è ÈÄöÁü•Ë®≠ÂÆö',
                weight: 'bold',
                size: 'lg'
              },
              {
                type: 'text',
                text: '„ÅäÂ•Ω„Åø„ÅÆÈÄöÁü•Ë®≠ÂÆö„ÇíË°å„Åà„Åæ„Åô',
                size: 'sm',
                color: '#666666',
                margin: 'md'
              }
            ]
          },
          footer: {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'button',
                style: 'primary',
                action: {
                  type: 'uri',
                  label: 'Ë®≠ÂÆöÁîªÈù¢„ÇíÈñã„Åè',
                  uri: settingsUrl
                }
              }
            ]
          }
        }
      };

      return await this.replyMessage(event.replyToken, [replyMessage]);
    }

    return { type: 'message_received', userId, messageText };
  }

  async handleFollowEvent(event) {
    const userId = event.source.userId;
    
    const welcomeMessage = {
      type: 'flex',
      altText: 'Hotel Booking Premium „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ',
      contents: {
        type: 'bubble',
        body: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'text',
              text: 'üè® Hotel Booking Premium',
              weight: 'bold',
              size: 'lg'
            },
            {
              type: 'text',
              text: '„ÅîÁôªÈå≤„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ',
              size: 'md',
              margin: 'md'
            },
            {
              type: 'text',
              text: 'È´òÁ¥ö„Éõ„ÉÜ„É´„ÅÆÁ©∫ÂÆ§ÊÉÖÂ†±„ÇÑÁâπ‰æ°ÊÉÖÂ†±„Çí„ÅÑ„Å°Êó©„Åè„ÅäÂ±ä„Åë„Åó„Åæ„Åô„ÄÇ',
              size: 'sm',
              color: '#666666',
              wrap: true,
              margin: 'md'
            }
          ]
        },
        footer: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'button',
              style: 'primary',
              action: {
                type: 'uri',
                label: 'ÈÄöÁü•Ë®≠ÂÆö„ÇíË°å„ÅÜ',
                uri: `https://hotelbooking.com/settings?line_user_id=${userId}`
              }
            }
          ]
        }
      }
    };

    await this.replyMessage(event.replyToken, [welcomeMessage]);
    
    return { type: 'follow', userId };
  }

  async handleUnfollowEvent(event) {
    const userId = event.source.userId;
    // TODO: Update user preferences to disable LINE notifications
    return { type: 'unfollow', userId };
  }

  async replyMessage(replyToken, messages) {
    try {
      const response = await axios.post(
        `${this.lineApiUrl}/message/reply`,
        {
          replyToken,
          messages
        },
        {
          headers: {
            'Authorization': `Bearer ${this.channelAccessToken}`,
            'Content-Type': 'application/json'
          }
        }
      );

      return {
        success: true,
        messageId: response.headers['x-line-request-id']
      };
    } catch (error) {
      console.error('Failed to reply LINE message:', error.response?.data || error.message);
      throw error;
    }
  }

  // Utility methods
  generateUrgencyMessage(urgencyLevel, hotelName, discountPercentage) {
    const urgencyTexts = {
      10: 'üö® Ë∂ÖÁ∑äÊÄ•ÔºÅ',
      9: 'üî• Á∑äÊÄ•ÔºÅ',
      8: '‚ö° È´òÂÑ™ÂÖàÂ∫¶ÔºÅ',
      7: 'üìç ÈáçË¶ÅÔºÅ',
      6: 'üìå „ÅäÁü•„Çâ„Åõ',
      5: '‚ÑπÔ∏è ÊÉÖÂ†±',
      4: 'üìã ÈÄöÁü•',
      3: 'üì¢ Ê°àÂÜÖ',
      2: 'üí° „ÅäÂæóÊÉÖÂ†±',
      1: 'üì∞ „Éã„É•„Éº„Çπ'
    };

    const urgencyText = urgencyTexts[urgencyLevel] || urgencyTexts[5];
    const discountText = discountPercentage > 0 ? ` ${Math.round(discountPercentage)}%OFF` : '';
    
    return `${urgencyText} ${hotelName}${discountText} Á©∫ÂÆ§ÊÉÖÂ†±„Çí„ÅäÂ±ä„Åë„Åó„Åæ„ÅôÔºÅ`;
  }

  getUrgencyColor(urgencyLevel) {
    if (urgencyLevel >= 9) return '#ff3333';
    if (urgencyLevel >= 7) return '#ff6b35';
    if (urgencyLevel >= 5) return '#ffa500';
    if (urgencyLevel >= 3) return '#3498db';
    return '#95a5a6';
  }

  getUrgencyEmoji(urgencyLevel) {
    if (urgencyLevel >= 9) return 'üö®';
    if (urgencyLevel >= 7) return 'üî•';
    if (urgencyLevel >= 5) return '‚ö°';
    if (urgencyLevel >= 3) return 'üìç';
    return '‚ÑπÔ∏è';
  }

  formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ja-JP', {
      month: 'short',
      day: 'numeric',
      weekday: 'short'
    });
  }

  formatCurrency(amount) {
    return new Intl.NumberFormat('ja-JP', {
      style: 'currency',
      currency: 'JPY'
    }).format(amount);
  }

  calculateTimeLeft(validUntil) {
    const now = new Date();
    const expiry = new Date(validUntil);
    const diffMs = expiry - now;
    
    if (diffMs <= 0) return 'ÁµÇ‰∫Ü';
    
    const hours = Math.floor(diffMs / (1000 * 60 * 60));
    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
    
    if (hours > 0) {
      return `${hours}ÊôÇÈñì${minutes}ÂàÜ`;
    }
    return `${minutes}ÂàÜ`;
  }

  async healthCheck() {
    try {
      // Test LINE API connectivity with a simple quota check
      const response = await axios.get(
        `${this.lineApiUrl}/message/quota`,
        {
          headers: {
            'Authorization': `Bearer ${this.channelAccessToken}`
          }
        }
      );

      return {
        status: 'healthy',
        quota: response.data,
        timestamp: new Date().toISOString()
      };
    } catch (error) {
      return {
        status: 'unhealthy',
        error: error.response?.data || error.message,
        timestamp: new Date().toISOString()
      };
    }
  }
}

// Export singleton instance
module.exports = new LineNotificationService();